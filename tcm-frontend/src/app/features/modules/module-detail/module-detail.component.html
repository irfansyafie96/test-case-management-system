<ng-container *ngIf="vm$ | async as vm">
  <div class="page-container">
    
    <!-- Loading State -->
    <div *ngIf="vm.loading" class="loading-overlay">
      <div class="loading-box">
        <mat-spinner diameter="32"></mat-spinner>
        <p>Accessing Module Data...</p>
      </div>
    </div>

    <!-- Content -->
    <div *ngIf="!vm.loading && !vm.error && vm.module?.id">
      <div class="project-header-section">
        <div class="breadcrumb">
           <a routerLink="/projects" class="back-link">
            <mat-icon>arrow_back</mat-icon> Projects
           </a> 
           <span class="separator">/</span>
           <a [routerLink]="['/projects', vm.module!.projectId]" class="back-link">Modules</a>
        </div>
        
        <div class="dossier-header">
          <div class="dossier-title">
            <h1>{{ vm.module!.name }}</h1>
            <p>{{ vm.module!.description || 'No description provided.' }}</p>
          </div>
          <div class="dossier-actions">
            <button 
              mat-raised-button 
              color="primary" 
              (click)="createTestSuite(vm.module!.id)"
              *ngIf="authService.hasAnyRole(['ADMIN', 'QA', 'BA'])">
              <mat-icon>add</mat-icon> NEW SUITE
            </button>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="toggleAssignments()"
              *ngIf="authService.hasAnyRole(['ADMIN', 'QA', 'BA'])">
              <mat-icon>{{ showAssignments ? 'close' : 'group' }}</mat-icon>
              {{ showAssignments ? 'CLOSE ASSIGNMENTS' : 'MANAGE ASSIGNMENTS' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Assignment Management (Top Position) -->
      <div *ngIf="showAssignments" class="assignments-container">
        <div class="section-header">
          <h2><mat-icon>group</mat-icon> Module Assignments</h2>
          <div class="count-badge">{{ assignedUsers.length }} Assigned</div>
        </div>
        
        <div *ngIf="loadingAssignments" class="loading-overlay-inline">
          <mat-spinner diameter="32"></mat-spinner>
          <p>Loading assignments...</p>
        </div>
        <div *ngIf="!loadingAssignments">
          <div class="assigned-users-list">
            <div *ngFor="let user of assignedUsers" class="user-card">
              <div class="user-info">
                <mat-icon class="user-icon">person</mat-icon>
                <div class="user-details">
                  <h4>{{ user.username }}</h4>
                  <p>{{ user.email }}</p>
                  <div class="user-roles">
                    <span *ngFor="let role of user.roles" class="role-badge">{{ role }}</span>
                  </div>
                </div>
              </div>
              <button mat-icon-button color="warn" (click)="removeUser(user.id.toString())" matTooltip="Remove user">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          
          <div *ngIf="!assignedUsers.length" class="empty-state compact">
            <div class="empty-content">
              <mat-icon class="empty-icon">group_off</mat-icon>
              <h3>No users assigned</h3>
              <p>No users are currently assigned to this module.</p>
            </div>
          </div>
          
          <div class="add-user-form">
            <h3>Assign New User</h3>
            <div class="form-row">
              <mat-form-field appearance="outline" class="user-select">
                <mat-label>Select User</mat-label>
                <mat-select [(ngModel)]="selectedUserId">
                  <mat-option *ngFor="let user of availableUsers" [value]="user.id.toString()">
                    {{ user.username }} ({{ user.email }})
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <button mat-raised-button color="primary" [disabled]="!selectedUserId" (click)="assignUser(selectedUserId!)">
                <mat-icon>add</mat-icon> Assign User
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="content-section">
        <div class="section-header">
          <h2><mat-icon>folder_special</mat-icon> Test Suites</h2>
        </div>

        <div class="test-suites-container">
          <div *ngFor="let suite of vm.module!.testSuites || []" class="suite-folder">
            <div class="suite-header">
              <div class="suite-title">
                <mat-icon>folder</mat-icon>
                <h3>{{ suite.name }}</h3>
              </div>
              <div class="suite-actions">
                <button
                  mat-stroked-button
                  class="small-btn"
                  (click)="createTestCase(suite.id)"
                  *ngIf="authService.hasAnyRole(['ADMIN', 'QA', 'BA'])">
                  <mat-icon>post_add</mat-icon> ADD CASE
                </button>
              </div>
            </div>
            
            <div class="suite-content">
              <table mat-table [dataSource]="suite.testCases || []" class="bespoke-table">
                <!-- ID Column -->
                <ng-container matColumnDef="id">
                  <th mat-header-cell *matHeaderCellDef> ID </th>
                                    <td mat-cell *matCellDef="let testCase">
                                       {{ testCase.testCaseId }}
                                    </td>                </ng-container>

                <!-- Title Column -->
                <ng-container matColumnDef="title">
                  <th mat-header-cell *matHeaderCellDef> TITLE </th>
                  <td mat-cell *matCellDef="let testCase" class="title-cell"> {{ testCase.title }} </td>
                </ng-container>


                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef> STATUS </th>
                  <td mat-cell *matCellDef="let testCase">
                    <span class="status-badge" [ngClass]="getStatusClass(testCase.status)">{{ testCase.status || 'DRAFT' }}</span>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef> ACTIONS </th>
                  <td mat-cell *matCellDef="let testCase" class="actions-cell">
                    <button
                      mat-icon-button
                      matTooltip="Edit test case"
                      (click)="editTestCase(testCase)"
                      color="primary"
                      class="action-btn"
                      *ngIf="authService.hasAnyRole(['ADMIN', 'QA', 'BA'])">
                      <mat-icon>edit</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>
              </table>

              <div *ngIf="!suite.testCases?.length" class="empty-suite-msg">
                No test cases in this suite.
              </div>
            </div>
          </div>

          <div *ngIf="!(vm.module!.testSuites?.length)" class="empty-state">
            <div class="empty-content">
              <div class="empty-icon-wrapper">
                <mat-icon class="empty-icon">folder_open</mat-icon>
              </div>
              <h2>Empty Module</h2>
              <p *ngIf="authService.hasAnyRole(['ADMIN', 'QA', 'BA'])">Create a test suite to begin organizing test cases.</p>
              <p *ngIf="!authService.hasAnyRole(['ADMIN', 'QA', 'BA'])">No test suites found. Contact an administrator to create test suites.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="!vm.loading && (vm.error || !vm.module?.id)">
      <div class="empty-state">
         <div class="empty-content">
           <mat-icon class="empty-icon error-icon">error_outline</mat-icon>
           <h3>Module Not Found</h3>
           <p>The requested module could not be located.</p>
           <button mat-raised-button color="warn" [routerLink]="['/projects']">RETURN TO PROJECTS</button>
         </div>
      </div>
    </div>
  </div>
</ng-container>
