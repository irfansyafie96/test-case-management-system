<ng-container *ngIf="vm$ | async as vm">
  <div class="page-container">
    
    <!-- Loading State -->
    <div *ngIf="vm.loading" class="loading-overlay">
      <div class="loading-box">
        <mat-spinner diameter="32"></mat-spinner>
        <p>Accessing Module Data...</p>
      </div>
    </div>

    <!-- Content -->
    <div *ngIf="!vm.loading && !vm.error && vm.module?.id">
      <div class="page-header">
        <div>
          <div class="breadcrumb">
             <a routerLink="/projects" class="back-link">
              <mat-icon>arrow_back</mat-icon> Projects
             </a> 
             <span class="separator">/</span>
             <a [routerLink]="['/projects', vm.module!.projectId]" class="back-link">Modules</a>
          </div>
          <h1 class="page-title"><mat-icon>view_module</mat-icon> {{ vm.module!.name }}</h1>
          <p class="page-subtitle">{{ vm.module!.description || 'No description provided.' }}</p>
        </div>
      </div>

      <div class="content-section">
        <div class="section-header">
          <h2><mat-icon>folder_special</mat-icon> Test Suites</h2>
          <button mat-raised-button color="primary" (click)="createTestSuite(vm.module!.id)">
            <mat-icon>add</mat-icon> NEW SUITE
          </button>
        </div>

        <div class="test-suites-container">
          <div *ngFor="let suite of vm.module!.testSuites || []" class="suite-folder">
            <div class="suite-header">
              <div class="suite-title">
                <mat-icon>folder</mat-icon>
                <h3>{{ suite.name }}</h3>
              </div>
              <div class="suite-actions">
                <button
                  mat-stroked-button
                  class="small-btn"
                  (click)="createTestCase(suite.id)">
                  <mat-icon>post_add</mat-icon> ADD CASE
                </button>
              </div>
            </div>
            
            <div class="suite-content">
              <table mat-table [dataSource]="suite.testCases || []" class="bespoke-table">
                <!-- ID Column -->
                <ng-container matColumnDef="id">
                  <th mat-header-cell *matHeaderCellDef> ID </th>
                  <td mat-cell *matCellDef="let testCase"> 
                     <span class="id-badge">{{ testCase.testCaseId }}</span> 
                  </td>
                </ng-container>

                <!-- Title Column -->
                <ng-container matColumnDef="title">
                  <th mat-header-cell *matHeaderCellDef> TITLE </th>
                  <td mat-cell *matCellDef="let testCase" class="title-cell"> {{ testCase.title }} </td>
                </ng-container>

                <!-- Priority Column -->
                <ng-container matColumnDef="priority">
                  <th mat-header-cell *matHeaderCellDef> PRIORITY </th>
                  <td mat-cell *matCellDef="let testCase">
                    <span class="priority-badge" [ngClass]="getPriorityClass(testCase.priority)">{{ testCase.priority }}</span>
                  </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef> STATUS </th>
                  <td mat-cell *matCellDef="let testCase">
                    <span class="status-badge" [ngClass]="getStatusClass(testCase.status)">{{ testCase.status || 'DRAFT' }}</span>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>
              </table>

              <div *ngIf="!suite.testCases?.length" class="empty-suite-msg">
                No test cases in this suite.
              </div>
            </div>
          </div>

          <div *ngIf="!(vm.module!.testSuites?.length)" class="empty-state">
            <div class="empty-content">
              <div class="empty-icon-wrapper">
                <mat-icon class="empty-icon">folder_open</mat-icon>
              </div>
              <h2>Empty Module</h2>
              <p>Create a test suite to begin organizing test cases.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="!vm.loading && (vm.error || !vm.module?.id)">
      <div class="empty-state">
         <div class="empty-content">
           <mat-icon class="empty-icon error-icon">error_outline</mat-icon>
           <h3>Module Not Found</h3>
           <p>The requested module could not be located.</p>
           <button mat-raised-button color="warn" [routerLink]="['/projects']">RETURN TO PROJECTS</button>
         </div>
      </div>
    </div>
  </div>
</ng-container>
