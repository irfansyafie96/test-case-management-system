<h1 mat-dialog-title>Import Test Cases</h1>

<div mat-dialog-content class="dialog-content">
  <p class="dialog-subtitle" *ngIf="!isUploading && !uploadResult">Bulk create test cases by uploading an Excel file.</p>

  <!-- Upload Section (Visible when NOT uploading AND no result) -->
  <div class="content-wrapper" *ngIf="!isUploading && !uploadResult?.success">
    
    <!-- Step 1: Template -->
    <div class="form-section">
      <h3 class="section-title">1. Prepare Data</h3>
      <div class="template-card">
        <div class="template-info">
          <mat-icon class="info-icon">table_view</mat-icon>
          <span>Download the template to format your test cases correctly.</span>
        </div>
        <button mat-stroked-button color="primary" (click)="downloadTemplate()">
          <mat-icon>download</mat-icon> Download Template
        </button>
      </div>
    </div>

    <mat-divider class="bold-divider"></mat-divider>

    <!-- Step 2: Upload -->
    <div class="form-section">
      <h3 class="section-title">2. Upload File</h3>
      
      <div class="upload-area"
           [class.drag-over]="false"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)"
           [class.has-file]="selectedFile !== null"
           (click)="!selectedFile && fileInput.click()">

        <input #fileInput type="file" (change)="onFileSelected($event)" accept=".xlsx" style="display: none;">

        <!-- Placeholder State -->
        <div *ngIf="!selectedFile" class="upload-placeholder">
          <div class="icon-circle">
            <mat-icon>cloud_upload</mat-icon>
          </div>
          <p class="upload-heading">Click or drag file here to upload</p>
          <p class="upload-subtext">Support for a single .xlsx file (max 10MB)</p>
        </div>

        <!-- Selected State -->
        <div *ngIf="selectedFile" class="file-selected-state">
          <div class="file-icon-wrapper">
             <mat-icon>description</mat-icon>
          </div>
          <div class="file-details">
            <span class="file-name-text">{{ selectedFile.name }}</span>
            <span class="file-size-text">{{ formatFileSize(selectedFile.size) }}</span>
          </div>
          <button mat-icon-button color="warn" (click)="$event.stopPropagation(); removeFile()" matTooltip="Remove file">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
      
      <div *ngIf="errorMessage" class="error-banner">
        <mat-icon>error_outline</mat-icon>
        <span>{{ errorMessage }}</span>
      </div>
    </div>
  </div>

  <!-- Loading State (Swapped View) -->
  <div *ngIf="isUploading" class="loading-view">
    <div class="spinner-container">
      <mat-spinner diameter="60" strokeWidth="4"></mat-spinner>
    </div>
    <h3 class="processing-title">Processing Import...</h3>
    <p class="processing-subtitle">Reading file structure and generating test cases.</p>
  </div>

  <!-- Result Section -->
  <div *ngIf="uploadResult && !isUploading" class="result-section">
    <!-- Success -->
    <div *ngIf="uploadResult.success" class="success-content">
      <div class="success-icon-wrapper">
        <mat-icon>check</mat-icon>
      </div>
      <h3>Import Complete!</h3>
      
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-val">{{ uploadResult.suitesCreated }}</span>
          <span class="stat-lbl">Suites</span>
        </div>
        <div class="stat-card">
          <span class="stat-val">{{ uploadResult.testCasesCreated }}</span>
          <span class="stat-lbl">Test Cases</span>
        </div>
         <div class="stat-card" *ngIf="uploadResult.testCasesSkipped > 0">
          <span class="stat-val">{{ uploadResult.testCasesSkipped }}</span>
          <span class="stat-lbl">Skipped</span>
        </div>
      </div>
    </div>

    <!-- Error -->
    <div *ngIf="!uploadResult.success" class="error-content">
       <div class="error-header">
         <mat-icon color="warn">error</mat-icon>
         <h3>Import Failed</h3>
       </div>
       <p class="error-main-msg">{{ uploadResult.message }}</p>
       
       <div *ngIf="uploadResult.errors?.length" class="error-list-container">
         <div class="error-list-header">Details:</div>
         <ul class="error-list">
           <li *ngFor="let err of uploadResult.errors">{{ err }}</li>
         </ul>
       </div>
    </div>
  </div>

</div>

<div mat-dialog-actions align="end" class="dialog-actions">
  <button mat-button (click)="onCancel()" *ngIf="!uploadResult">CANCEL</button>
  <button
    mat-raised-button
    color="primary"
    (click)="onClose()"
    *ngIf="uploadResult">
    {{ uploadResult.success ? 'DONE' : 'CLOSE' }}
  </button>
  <button
    mat-raised-button
    color="primary"
    (click)="onSubmit()"
    *ngIf="!uploadResult && !isUploading"
    [disabled]="!selectedFile">
    IMPORT
  </button>
</div>