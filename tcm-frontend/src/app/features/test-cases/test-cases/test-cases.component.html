<ng-container *ngIf="vm$ | async as vm">
  <div class="page-container">
    
    <!-- Loading State -->
    <div *ngIf="vm.loading" class="loading-overlay">
      <div class="loading-box">
        <mat-spinner diameter="32"></mat-spinner>
        <p>Retrieving Test Specifications...</p>
      </div>
    </div>

    <div class="page-header">
      <div>
        <h1 class="page-title"><mat-icon>list_alt</mat-icon> Global Test Cases</h1>
        <p class="page-subtitle">Master list of all test definitions across the system.</p>
      </div>
    </div>

    <!-- Content -->
    <div *ngIf="!vm.loading && !vm.error">
      
      <!-- Stats Dashboard -->
      <div class="stats-dashboard" *ngIf="vm.testCases.length">
        <div class="stat-card total-card">
          <div class="stat-icon">
            <mat-icon>library_books</mat-icon>
          </div>
          <div class="stat-content">
            <span class="stat-label">Total Test Cases</span>
            <span class="stat-number">{{ vm.stats.total }}</span>
          </div>
        </div>

        <div class="stat-card distribution-card">
          <h3><mat-icon>pie_chart</mat-icon> Distribution by Project</h3>
          <div class="bars-container">
            <div *ngFor="let p of vm.stats.byProject" class="bar-row">
              <div class="bar-label">
                <span class="p-name">{{ p.name }}</span>
                <span class="p-count">{{ p.count }}</span>
              </div>
              <div class="bar-track">
                <div class="bar-fill" [style.width.%]="(p.count / vm.stats.total) * 100"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="vm.testCases.length; else emptyState">
        <!-- Desktop Table View -->
        <div class="mat-elevation-z0 table-container-styled desktop-view">
          <table mat-table [dataSource]="vm.testCases" class="bespoke-table">
            
            <!-- ID Column -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef> ID </th>
              <td mat-cell *matCellDef="let element"> 
                <span class="id-badge">{{ element.testCaseId }}</span> 
              </td>
            </ng-container>

            <!-- Title Column -->
            <ng-container matColumnDef="title">
              <th mat-header-cell *matHeaderCellDef> TITLE </th>
              <td mat-cell *matCellDef="let element" class="title-cell"> 
                <a [routerLink]="['/test-cases', element.id]" class="table-link">{{ element.title }}</a>
              </td>
            </ng-container>

            <!-- Project Column -->
            <ng-container matColumnDef="project">
              <th mat-header-cell *matHeaderCellDef> PROJECT </th>
              <td mat-cell *matCellDef="let element">
                <span class="context-text">
                  {{ element.projectName || element.testSuite?.testModule?.project?.name || '-' }}
                </span>
              </td>
            </ng-container>

            <!-- Module Column -->
            <ng-container matColumnDef="module">
              <th mat-header-cell *matHeaderCellDef> MODULE </th>
              <td mat-cell *matCellDef="let element">
                <span class="context-text">
                  {{ element.moduleName || element.testSuite?.testModule?.name || '-' }}
                </span>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef> ACTIONS </th>
              <td mat-cell *matCellDef="let element">
                <button mat-icon-button [routerLink]="['/test-cases', element.id]" color="primary" matTooltip="View Details">
                  <mat-icon>visibility</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>
          </table>
        </div>

        <!-- Mobile Card View -->
        <div class="mobile-view">
          <div *ngFor="let element of vm.testCases" class="mobile-test-card" [routerLink]="['/test-cases', element.id]">
            <div class="mobile-card-header">
              <span class="id-badge">{{ element.testCaseId }}</span>
            </div>
            <div class="mobile-card-body">
              <h3>{{ element.title }}</h3>
              <div class="context-info" *ngIf="element.projectName || element.testSuite?.testModule?.project">
                <mat-icon class="tiny-icon">folder</mat-icon> 
                {{ element.projectName || element.testSuite?.testModule?.project?.name }} / {{ element.moduleName || element.testSuite?.testModule?.name }}
              </div>
            </div>
            <div class="mobile-card-footer">
              <mat-icon class="action-icon">visibility</mat-icon> View Details
            </div>
          </div>
        </div>
      </div>

      <ng-template #emptyState>
        <div class="empty-state">
          <div class="empty-content">
            <div class="empty-icon-wrapper">
              <mat-icon class="empty-icon">assignment_late</mat-icon>
            </div>
            <h2>No Test Cases Found</h2>
            <p>The system currently has no test definitions. Create a project and module to start defining tests.</p>
            <button mat-raised-button color="primary" routerLink="/projects">
              <mat-icon>arrow_forward</mat-icon> Go to Projects
            </button>
          </div>
        </div>
      </ng-template>
    </div>

    <!-- Error State -->
    <div *ngIf="!vm.loading && vm.error">
      <div class="empty-state">
         <div class="empty-content">
           <mat-icon class="empty-icon error-icon">error_outline</mat-icon>
           <h3>System Error</h3>
           <p>Unable to retrieve the master test case list.</p>
           <button mat-raised-button color="warn" (click)="loadTestCases()">RETRY</button>
         </div>
      </div>
    </div>
  </div>
</ng-container>

