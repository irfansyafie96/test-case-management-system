<ng-container *ngIf="vm$ | async as vm">
  <div class="page-container">
    
    <!-- Loading State -->
    <div *ngIf="vm.loading" class="loading-overlay">
      <div class="loading-box">
        <mat-spinner diameter="32"></mat-spinner>
        <p>Loading Analytics...</p>
      </div>
    </div>

    <div class="page-header">
      <div>
        <h1 class="page-title"><mat-icon>analytics</mat-icon> Test Analytics Dashboard</h1>
        <p class="page-subtitle">Overview of test execution results across all projects.</p>
      </div>
      <!-- User filter for admin -->
      <div *ngIf="isAdmin" class="user-filter">
        <mat-form-field appearance="outline">
          <mat-label>Filter by User</mat-label>
          <mat-select [(value)]="selectedUserId" (selectionChange)="onUserFilterChange($event.value)">
            <mat-option [value]="null">All Users</mat-option>
            <mat-option *ngFor="let user of users" [value]="user.id">
              {{ user.username }} <span *ngFor="let role of user.roles" class="role-badge">{{ role }}</span>
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- Content -->
    <div *ngIf="!vm.loading && !vm.error">
      
      <!-- KPI Cards -->
      <div class="kpi-cards">
        <div class="kpi-card total-cases">
          <div class="kpi-icon">
            <mat-icon>library_books</mat-icon>
          </div>
          <div class="kpi-content">
            <span class="kpi-label">Total Test Cases</span>
            <span class="kpi-number">{{ vm.analytics.totalTestCases }}</span>
          </div>
        </div>

        <div class="kpi-card executed">
          <div class="kpi-icon">
            <mat-icon>play_circle</mat-icon>
          </div>
          <div class="kpi-content">
            <span class="kpi-label">Executed</span>
            <span class="kpi-number">{{ vm.analytics.executedCount }}</span>
            <span class="kpi-sub">{{ getPercentage(vm.analytics.executedCount, vm.analytics.totalTestCases) }}%</span>
          </div>
        </div>

        <div class="kpi-card passed">
          <div class="kpi-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="kpi-content">
            <span class="kpi-label">Passed</span>
            <span class="kpi-number">{{ vm.analytics.passedCount }}</span>
            <span class="kpi-sub">{{ vm.analytics.passRate.toFixed(1) }}%</span>
          </div>
        </div>

        <div class="kpi-card failed">
          <div class="kpi-icon">
            <mat-icon>cancel</mat-icon>
          </div>
          <div class="kpi-content">
            <span class="kpi-label">Failed</span>
            <span class="kpi-number">{{ vm.analytics.failedCount }}</span>
            <span class="kpi-sub">{{ vm.analytics.failRate.toFixed(1) }}%</span>
          </div>
        </div>

        <div class="kpi-card not-executed">
          <div class="kpi-icon">
            <mat-icon>schedule</mat-icon>
          </div>
          <div class="kpi-content">
            <span class="kpi-label">Not Executed</span>
            <span class="kpi-number">{{ vm.analytics.notExecutedCount }}</span>
            <span class="kpi-sub">{{ getPercentage(vm.analytics.notExecutedCount, vm.analytics.totalTestCases) }}%</span>
          </div>
        </div>
      </div>

      <!-- Pass/Fail Progress -->
      <div class="progress-section">
        <h2 class="section-title">Execution Progress</h2>
        <div class="progress-bars">
          <div class="progress-item">
            <div class="progress-label">
              <span class="label-text">Passed</span>
              <span class="label-value">{{ vm.analytics.passedCount }} ({{ vm.analytics.passRate.toFixed(1) }}%)</span>
            </div>
            <mat-progress-bar mode="determinate" [value]="vm.analytics.passRate" class="progress-bar passed-bar"></mat-progress-bar>
          </div>

          <div class="progress-item">
            <div class="progress-label">
              <span class="label-text">Failed</span>
              <span class="label-value">{{ vm.analytics.failedCount }} ({{ vm.analytics.failRate.toFixed(1) }}%)</span>
            </div>
            <mat-progress-bar mode="determinate" [value]="vm.analytics.failRate" class="progress-bar failed-bar"></mat-progress-bar>
          </div>

          <div class="progress-item">
            <div class="progress-label">
              <span class="label-text">Not Executed</span>
              <span class="label-value">{{ vm.analytics.notExecutedCount }} ({{ getPercentage(vm.analytics.notExecutedCount, vm.analytics.totalTestCases) }}%)</span>
            </div>
            <mat-progress-bar mode="determinate" [value]="getPercentage(vm.analytics.notExecutedCount, vm.analytics.totalTestCases)" class="progress-bar not-executed-bar"></mat-progress-bar>
          </div>
        </div>
      </div>

      <!-- Module Breakdown -->
      <div class="module-breakdown" *ngIf="vm.analytics.byModule.length">
        <h2 class="section-title">Module Breakdown</h2>
        <div class="module-list">
          <div *ngFor="let module of vm.analytics.byModule" class="module-card">
            <div class="module-header">
              <div class="module-info">
                <mat-icon class="module-icon">folder</mat-icon>
                <div>
                  <h3>{{ module.moduleName }}</h3>
                  <span class="project-name">{{ module.projectName }}</span>
                </div>
              </div>
              <div class="module-stats">
                <span class="stat-badge total">{{ module.totalTestCases }} Total</span>
                <span class="stat-badge executed">{{ module.executedCount }} Executed</span>
              </div>
            </div>

            <div class="module-progress">
              <div class="progress-item compact">
                <span class="label-mini">Passed: {{ module.passedCount }}</span>
                <mat-progress-bar mode="determinate" [value]="getPercentage(module.passedCount, module.totalTestCases)" class="progress-bar passed-bar"></mat-progress-bar>
              </div>
              <div class="progress-item compact">
                <span class="label-mini">Failed: {{ module.failedCount }}</span>
                <mat-progress-bar mode="determinate" [value]="getPercentage(module.failedCount, module.totalTestCases)" class="progress-bar failed-bar"></mat-progress-bar>
              </div>
              <div class="progress-item compact">
                <span class="label-mini">Not Executed: {{ module.notExecutedCount }}</span>
                <mat-progress-bar mode="determinate" [value]="getPercentage(module.notExecutedCount, module.totalTestCases)" class="progress-bar not-executed-bar"></mat-progress-bar>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!vm.analytics.totalTestCases" class="empty-state">
        <div class="empty-content">
          <div class="empty-icon-wrapper">
            <mat-icon class="empty-icon">analytics</mat-icon>
          </div>
          <h2>No Test Data Available</h2>
          <p>There are no test cases in the system yet. Create a project and module to start defining tests.</p>
          <button mat-raised-button color="primary" routerLink="/projects">
            <mat-icon>add</mat-icon> Create Project
          </button>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="!vm.loading && vm.error">
      <div class="empty-state">
         <div class="empty-content">
           <mat-icon class="empty-icon error-icon">error_outline</mat-icon>
           <h3>System Error</h3>
           <p>Unable to retrieve analytics data.</p>
           <button mat-raised-button color="warn" (click)="loadAnalytics()">RETRY</button>
         </div>
      </div>
    </div>
  </div>
</ng-container>

