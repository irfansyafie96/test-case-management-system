<div class="page-container">
  
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading test case details...</p>
  </div>

  <div *ngIf="error" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-button (click)="loadTestCase(testCaseId!)" *ngIf="testCaseId">Retry</button>
  </div>

  <ng-container *ngIf="!isLoading && !error && testCase">
    <div class="page-header-section">
      <div class="breadcrumb">
        <a routerLink="/test-cases" class="back-link">
          <mat-icon>arrow_back</mat-icon> Test Cases
        </a>
        <span class="separator">/</span>
        <span class="current">{{ testCase.testCaseId }}</span>
      </div>

      <div class="detail-header">
        <div class="header-left">
           <div class="id-tag">{{ testCase.testCaseId }}</div>
           <h1>Test Case Specification</h1>
        </div>
        <div class="header-actions">
          <button mat-raised-button 
                  color="accent" 
                  [disabled]="isPreviousDisabled" 
                  (click)="navigateToPrevious()"
                  matTooltip="Previous test case">
            <mat-icon>chevron_left</mat-icon> PREV
          </button>
          <button mat-stroked-button *ngIf="authService.hasAnyRole(['ADMIN', 'QA', 'BA'])" (click)="editTestCase()">
            <mat-icon>edit</mat-icon> EDIT
          </button>
          <button mat-raised-button color="primary" (click)="navigateToExecutions()">
            <mat-icon>play_arrow</mat-icon> EXECUTE
          </button>
          <button mat-raised-button 
                  color="accent" 
                  [disabled]="isNextDisabled" 
                  (click)="navigateToNext()"
                  matTooltip="Next test case">
            NEXT <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <div class="spec-grid">
      <!-- Left Column: Meta Data -->
      <div class="meta-column">
        <mat-card class="spec-card">
          <mat-card-header>
            <mat-card-title>Metadata</mat-card-title>
          </mat-card-header>
          <div class="key-value-grid">
            <!-- Hierarchy Context -->
            <div class="kv-item" *ngIf="testCase.projectName">
               <label>Project</label>
               <span class="data-text">{{ testCase.projectName }}</span>
            </div>
            <div class="kv-item" *ngIf="testCase.moduleName">
               <label>Module</label>
               <span class="data-text">{{ testCase.moduleName }}</span>
            </div>
            <div class="kv-item" *ngIf="testCase.submoduleName || testCase.submoduleId">
               <label>Submodule</label>
               <span class="data-text">{{ testCase.submoduleName || testCase.submoduleId }}</span>
            </div>

            <div class="kv-item" *ngIf="testCase.tags && testCase.tags.length > 0">
               <label>Tags</label>
               <div class="tags-list">
                 <mat-chip-set>
                   <mat-chip *ngFor="let tag of testCase.tags">{{ tag }}</mat-chip>
                 </mat-chip-set>
               </div>
            </div>
          </div>
        </mat-card>
      </div>

      <!-- Right Column: Content -->
      <div class="content-column">
         <mat-card class="spec-card content-spec-card">
           <div class="spec-section">
             <div class="spec-label">Title</div>
             <div class="spec-value">
               <p class="lead-text">{{ testCase.title }}</p>
             </div>
           </div>
           
           <div class="spec-section">
             <div class="spec-label">Description</div>
             <div class="spec-value">
               <p class="body-text">
                 {{ testCase.description || 'No description provided.' }}
               </p>
             </div>
           </div>

           <div class="spec-section" *ngIf="testCase.prerequisites">
             <div class="spec-label">Pre-conditions</div>
             <div class="spec-value">
               <p class="body-text">{{ testCase.prerequisites }}</p>
             </div>
           </div>

           <div class="spec-section">
             <div class="spec-label">Test Steps</div>
             <div class="spec-value">
               <div class="step-list" *ngIf="testCase.testSteps && testCase.testSteps.length > 0; else noSteps">
                 <div class="step-item" *ngFor="let step of testCase.testSteps">
                   <div class="step-number">{{ step.stepNumber | number:'2.0' }}</div>
                   <div class="step-content">
                     <strong>{{ step.action }}</strong>
                     <p>{{ step.expectedResult }}</p>
                   </div>
                 </div>
               </div>
               <ng-template #noSteps>
                  <p class="no-data">No steps defined for this test case.</p>
               </ng-template>
             </div>
           </div>

           <div class="spec-section" *ngIf="testCase.expectedResult">
             <div class="spec-label">Final Result</div>
             <div class="spec-value">
               <p class="result-text">{{ testCase.expectedResult }}</p>
             </div>
           </div>
         </mat-card>
      </div>
    </div>
  </ng-container>
</div>